{% load static %}

<nav class="main-header navbar navbar-expand navbar-dark bg-secondary">
    <!-- Left navbar -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link text-light" data-widget="pushmenu" href="#" role="button">
                <i class="fas fa-bars"></i>
            </a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link text-light">Accueil</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link text-light">Contact</a>
        </li>
    </ul>

    <!-- Search -->
    <form class="form-inline ml-3">
        <div class="input-group input-group-sm">
            <input class="form-control form-control-navbar"
                   type="search"
                   placeholder="Search"
                   id="search-input">
            <div class="input-group-append">
                <button class="btn btn-navbar" type="submit" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </form>

    <!-- Right navbar -->
    <ul class="navbar-nav ml-auto">

        <!-- ðŸ”” Notifications -->
        <li class="nav-item dropdown">
            <a class="nav-link text-light position-relative"
               data-toggle="dropdown"
               href="#"
               id="notif-bell">
                <i class="far fa-bell"></i>

                {% if navbar_unread_count > 0 %}
                    <span id="notif-count"
                          class="badge bg-danger navbar-badge">
                        {{ navbar_unread_count }}
                    </span>
                {% endif %}
            </a>

            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end
                        bg-dark text-light p-0 shadow"
                 style="min-width: 340px;">

                <h6 class="dropdown-header text-center bg-secondary text-white py-2 mb-0">
                    Notifications
                </h6>

                <div class="list-group list-group-flush"
                     style="max-height: 320px; overflow-y: auto;">

                    {% if navbar_notifications %}
                        {% for notif in navbar_notifications %}
                            <a href="{{ notif.action_url|default:'#' }}"
                               class="list-group-item list-group-item-action
                               {% if not notif.is_read %}
                                    bg-dark text-light shadow
                                {% else %}
                                    bg-light text-dark
                                {% endif %}">
                                                                
                                <div class="d-flex justify-content-between align-items-start">
                                    <span class="small">
                                        {{ notif.message }}
                                    </span>
                                    {% if not notif.is_read %}
                                        <span class="badge bg-info rounded-pill ms-2">
                                            New
                                        </span>
                                    {% endif %}
                                </div>

                                <small class="text-muted d-block mt-1">
                                    {{ notif.timestamp|timesince }} ago
                                </small>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-3 text-muted bg-light">
                            No notifications
                        </div>
                    {% endif %}
                </div>
            </div>
        </li>

        <!-- ðŸ‘¤ User -->
        <li class="nav-item dropdown">
            <a class="nav-link text-light" data-toggle="dropdown" href="#">
                <i class="fas fa-user"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-end bg-dark text-light shadow">
                <a href="{% url 'profile' %}" class="dropdown-item text-light">
                    <i class="fas fa-user-circle me-2"></i> Profile
                </a>
                <div class="dropdown-divider bg-secondary"></div>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit"
                            class="dropdown-item text-light w-100 text-start">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </button>
                </form>
            </div>
        </li>

    </ul>
</nav>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const bell = document.getElementById("notif-bell");
    const badge = document.getElementById("notif-count");

    if (bell) {
        bell.addEventListener("click", function () {
            fetch("{% url 'mark_all_notifications_read' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && badge) {
                    badge.remove();
                }
            });
        });
    }
});
</script>
